# 数据结构知识图谱数据生成器 - 使用说明

## 📋 概述

本工具是一个专门为数据结构课程设计的知识图谱数据生成器，能够自动生成高质量的训练数据，支持8种关系类型的均等分布，并直接生成DeepKE框架所需的标注文件格式。

## 🎯 主要功能

1. **LLM文本生成**：基于关系模板生成自然语言描述
2. **关系抽取标注**：自动生成DeepKE训练所需的标注文件
3. **数据质量控制**：确保关系类型均等分布和数据质量
4. **一键式集成**：四步流程自动完成所有数据生成任务

## ⚙️ 配置参数详解

### API配置
```python
# API相关配置
API_KEY = os.environ.get("ARK_API_KEY")  # 从环境变量获取API密钥
BASE_URL = "https://ark.cn-beijing.volces.com/api/v3"  # API服务地址
MODEL = "doubao-1-5-lite-32k-250115"  # 使用的LLM模型
TIMEOUT = 30  # API请求超时时间（秒）
RETRY_COUNT = 2  # 失败重试次数
DELAY_BETWEEN_REQUESTS = 0  # 请求间延迟（秒）
CONCURRENCY = 30  # 并发请求数量
```

### 数据生成配置
```python
NUM_RECORDS = 3000  # 总生成记录数（建议3000条，8种关系各375条）
MAX_PROMPTS = 1000  # 最大提示词数量（当前设置为1000）
MIN_PROMPTS_PER_RELATION = 5  # 每种关系最少生成的提示词数
```

### 文件路径配置
```python
# 输出文件路径
OUTPUT_FILE = "/root/KG_inde/generate_data/data_backups/knowledge_graph_sentences_2.txt"
PROMPTS_FILE = "kg_prompts.txt"  # LLM生成的提示词文件
VOCAB_DICT_FILE = "../DeepKE/example/ner/prepare-data/vocab_dict.csv"  # 词汇字典文件

# DeepKE标注文件输出路径
ANNOTATION_OUTPUT_DIR = "/root/KG_inde/DeepKE/example/re/standard/data/origin"
RELATION_FILE = "relation.csv"  # 关系映射文件
TRAIN_FILE = "train.csv"  # 训练数据文件
TEST_FILE = "test.csv"  # 测试数据文件
VALID_FILE = "valid.csv"  # 验证数据文件
```

## 🔄 任务流程说明

### 第一步：关系提示词生成
- **功能**：基于8种关系类型和知识库实体生成关系提示词
- **输出**：`kg_prompts.txt` 文件
- **关系类型**：
  - `rely`：依赖关系（A依赖B）
  - `b-rely`：被依赖关系（A被B依赖）
  - `belg`：所属关系（A属于B）
  - `b-belg`：被所属关系（A包含B）
  - `syno`：同义关系（A与B同义）
  - `relative`：相对关系（A与B相对）
  - `attr`：属性关系（A是B的属性）
  - `b-attr`：被属性关系（A具有属性B）

### 第二步：LLM文本生成
- **功能**：调用LLM API生成自然语言描述
- **输入**：关系提示词
- **输出**：高质量的知识图谱语料
- **特点**：
  - 支持并发请求（默认30个并发）
  - 自动重试机制
  - 数据质量验证

### 第三步：关系抽取标注文件生成
- **功能**：将生成的语料转换为DeepKE标注格式
- **输出文件**：
  - `relation.csv`：关系类型映射表
  - `train.csv`：训练数据（70%）
  - `valid.csv`：验证数据（15%）
  - `test.csv`：测试数据（15%）

### 第四步：数据统计与验证
- **功能**：统计生成数据的质量和分布
- **验证内容**：
  - 关系类型分布均匀性
  - 数据格式正确性
  - 文件完整性检查

## 🚀 使用方法

### 1. 环境准备
```bash
# 设置API密钥环境变量
export ARK_API_KEY="your_api_key_here"

# 安装依赖
pip install openai tqdm
```

### 2. 运行生成器
```bash
cd /root/KG_inde/generate_data
python generate_data.py
```

### 3. 查看输出
```bash
# 查看生成的提示词
head -10 kg_prompts.txt

# 查看DeepKE标注文件
ls -la /root/KG_inde/DeepKE/example/re/standard/data/origin/
head -5 /root/KG_inde/DeepKE/example/re/standard/data/origin/train.csv
```

## 📊 输出文件格式

### 1. kg_prompts.txt
```
静态内存需要使用逻辑结构
迭代是动态内存不可缺少的组成部分
加权图是数据项中的一员
...
```

### 2. relation.csv
```
head_type,tail_type,relation,index
CON,ARI,rely,0
CON,CON,b-rely,1
CON,CON,belg,2
...
```

### 3. train.csv
```
sentence,relation,head,tail,head_offset,tail_offset
静态内存需要使用逻辑结构,b-rely,逻辑结构,静态内存,8,0
迭代是动态内存不可缺少的组成部分,b-rely,动态内存,迭代,3,0
...
```

## 🎛️ 参数调优建议

### 生成数量调整
```python
# 小规模测试（快速验证）
NUM_RECORDS = 800  # 8种关系各100条

# 中等规模训练
NUM_RECORDS = 1600  # 8种关系各200条

# 大规模训练（推荐）
NUM_RECORDS = 3000  # 8种关系各375条
```

### 并发性能调整
```python
# 网络较慢时降低并发
CONCURRENCY = 10
DELAY_BETWEEN_REQUESTS = 0.1

# 网络较快时提高并发
CONCURRENCY = 50
DELAY_BETWEEN_REQUESTS = 0
```

## ❗ 注意事项

1. **API密钥**：确保设置正确的环境变量 `ARK_API_KEY`
2. **网络连接**：需要稳定的网络连接访问LLM API
3. **磁盘空间**：确保有足够空间存储生成的数据文件
4. **DeepKE路径**：确保DeepKE目录结构正确
5. **文件权限**：确保对输出目录有写入权限

## 🔧 常见问题解决

### Q1: API调用失败
```
解决方案：
1. 检查API_KEY环境变量是否正确设置
2. 验证网络连接是否正常
3. 确认API服务地址是否可访问
```

### Q2: 生成数据不均匀
```
解决方案：
1. 增加NUM_RECORDS数量
2. 检查关系模板是否完整
3. 验证实体库是否平衡
```

### Q3: 文件路径错误
```
解决方案：
1. 检查DeepKE目录是否存在
2. 确认输出目录权限
3. 使用绝对路径避免相对路径问题
```

## 📈 性能指标

- **生成速度**：约100-200条/分钟（取决于网络和并发设置）
- **数据质量**：>95%的生成语料符合关系要求
- **关系分布**：8种关系类型均等分布（±5%误差范围内）
- **文件大小**：3000条数据约生成200KB的标注文件

## 🔄 版本更新日志

- **v2.0**：集成四步式数据生成流程
- **v1.9**：优化代码结构，统一配置管理
- **v1.8**：删除提示词前缀，生成纯净训练语料
- **v1.7**：修复OpenAI库兼容性问题
- **v1.6**：添加DeepKE标注文件自动生成

---

💡 **提示**：建议首次使用时设置较小的 `NUM_RECORDS` 值进行测试，确认配置正确后再进行大规模数据生成。